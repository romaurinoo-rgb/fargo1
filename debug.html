<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Debug Admin Panel</title>
  <style>
    body { background: #0a0412; color: #fff; font-family: 'Inter', sans-serif; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .card { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .title { font-size: 18px; font-weight: 800; margin-bottom: 12px; }
    .sub { font-size: 14px; color: rgba(255,255,255,.6); margin-bottom: 16px; }
    button { background: #7d66ff; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; margin: 4px; }
    button:hover { background: #6d56e5; }
    button.bad { background: #ff3b6d; }
    button.bad:hover { background: #e5325d; }
    .output { background: rgba(0,0,0,.3); padding: 12px; border-radius: 8px; margin-top: 12px; font-family: monospace; font-size: 12px; max-height: 400px; overflow: auto; }
    input { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); padding: 8px 12px; border-radius: 8px; color: #fff; width: 100%; margin-bottom: 8px; box-sizing: border-box; }
    .status { padding: 8px 12px; border-radius: 6px; margin: 8px 0; font-weight: 700; }
    .status.good { background: rgba(71,224,143,.2); color: #47e08f; }
    .status.bad { background: rgba(255,59,109,.2); color: #ff3b6d; }
    .status.info { background: rgba(125,102,255,.2); color: #7d66ff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="title">üîç Debug Admin Panel</div>
      <div class="sub">–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –≤—Ö–æ–¥–æ–º</div>
    </div>

    <div class="card">
      <div class="title">0. Fa√ßa login aqui</div>
      <div class="sub">Use este formul√°rio para testar o login</div>
      <input id="debugUser" type="text" placeholder="Username" value="Fortina" />
      <input id="debugPass" type="password" placeholder="Password" value="Roma101000" />
      <button onclick="debugLogin()">Login de Teste</button>
      <div id="loginOutput" class="output"></div>
    </div>

    <div class="card">
      <div class="title">1. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å</div>
      <button onclick="checkStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–π —Å—Ç–∞—Ç—É—Å (cookies)</button>
      <button onclick="checkStatusWithToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–π —Å—Ç–∞—Ç—É—Å (localStorage)</button>
      <button onclick="listAllUsers()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
      <div id="statusOutput" class="output"></div>
    </div>

    <div class="card">
      <div class="title">2. –ò—Å–ø—Ä–∞–≤—å Fortina</div>
      <div class="sub">–ï—Å–ª–∏ Fortina –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–ª—å "–í–ª–∞–¥–µ–ª–µ—Ü", –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</div>
      <button class="bad" onclick="fixFortina()">üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å Fortina (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–ª–∞–¥–µ–ª–µ—Ü)</button>
      <div id="fixOutput" class="output"></div>
    </div>

    <div class="card">
      <div class="title">3. –õ–æ–≥–∏–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∞</div>
      <div style="font-size:13px; line-height:1.8;">
        <strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong><br>
        Username: Fortina<br>
        Password: Roma101000<br><br>
        <strong>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä:</strong><br>
        Username: Alina<br>
        Password: Alina2026<br><br>
        <strong>–ü–æ–º–æ—â–Ω–∏–∫:</strong><br>
        Username: Daniil<br>
        Password: Daniil2026
      </div>
    </div>
  </div>

  <script>
    async function debugLogin(){
      const output = document.getElementById('loginOutput');
      const user = document.getElementById('debugUser').value;
      const pass = document.getElementById('debugPass').value;
      
      try{
        output.textContent = 'Fazendo login...';
        const resp = await fetch('/api/admin/login', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, pass })
        });
        
        const data = await resp.json();
        
        if(resp.ok){
          // Store token in localStorage as fallback
          if(data.token){
            localStorage.setItem('admin_token', data.token);
            console.log('Token stored in localStorage');
          }
          output.innerHTML = `<div class="status good">‚úÖ Login bem-sucedido!</div>User: <strong>${data.user}</strong><br>Role: <strong>${data.role}</strong><br><br><div style="font-size:12px;">Token salvo em localStorage<br>Agora clica em "Probar estatuto"</div>`;
        }else{
          output.innerHTML = `<div class="status bad">‚ùå Login falhou</div>Erro: ${data.error}`;
        }
      }catch(e){
        output.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }

    async function checkStatus(){
      const output = document.getElementById('statusOutput');
      try{
        output.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        const resp = await fetch('/api/admin/status', { 
          credentials: 'include',
          method: 'GET'
        });
        const data = await resp.json();
        
        let html = `<strong>–°—Ç–∞—Ç—É—Å –∞–≤—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:</strong>\n`;
        if(data.authed){
          html += `<div class="status good">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω</div>`;
          html += `Username: <strong>${data.user}</strong>\n`;
          html += `Role: <strong>${data.role}</strong>\n`;
        }else{
          html += `<div class="status bad">‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω</div>`;
          html += `–ü—Ä–∏—á–∏–Ω–∞: ${data.reason}\n`;
        }
        
        output.innerHTML = html.replace(/\n/g, '<br>');
      }catch(e){
        output.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }

    async function checkStatusWithToken(){
      const output = document.getElementById('statusOutput');
      try{
        output.textContent = 'Verificando com token...';
        const token = localStorage.getItem('admin_token');
        
        if(!token){
          output.innerHTML = `<div class="status bad">‚ùå Nenhum token no localStorage</div>Fa√ßa login primeiro`;
          return;
        }

        const resp = await fetch('/api/admin/status-token', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json();
        
        let html = `<strong>Estatuto (com token localStorage):</strong><br>`;
        if(data.authed){
          html += `<div class="status good">‚úÖ Autorizado!</div>`;
          html += `Username: <strong>${data.user}</strong><br>`;
          html += `Role: <strong>${data.role}</strong>`;
        }else{
          html += `<div class="status bad">‚ùå N√£o autorizado</div>`;
          html += `Raz√£o: ${data.reason}`;
        }
        
        output.innerHTML = html;
      }catch(e){
        output.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }

    async function listAllUsers(){
      const output = document.getElementById('statusOutput');
      try{
        output.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const resp = await fetch('/api/admin/users-debug', { 
          credentials: 'include',
          method: 'GET'
        });
        const data = await resp.json();
        
        let html = `<strong>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –ë–î:</strong>\n`;
        if(data.users && data.users.length > 0){
          data.users.forEach(u => {
            html += `\nID: ${u.id}, User: <strong>${u.user}</strong>, Role: <strong>${u.role}</strong>`;
          });
        }else{
          html += `–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
        }
        
        output.innerHTML = html.replace(/\n/g, '<br>');
      }catch(e){
        output.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }

    async function fixFortina(){
      const output = document.getElementById('fixOutput');
      try{
        output.textContent = '–ò—Å–ø—Ä–∞–≤–ª—è—é...';
        const resp = await fetch('/api/admin/fix-fortina', { 
          method: 'POST',
          credentials: 'include'
        });
        const data = await resp.json();
        
        if(resp.ok){
          output.innerHTML = `<div class="status good">‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!</div>\nUser: <strong>${data.user}</strong>\nRole: <strong>${data.role}</strong>`;
        }else{
          output.innerHTML = `<div class="status bad">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
        }
      }catch(e){
        output.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
      }
    }

    // Check status on page load
    window.addEventListener('load', () => {
      checkStatus();
    });
  </script>
</body>
</html>
